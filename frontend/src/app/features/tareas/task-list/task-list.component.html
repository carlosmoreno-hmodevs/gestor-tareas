<div class="task-list-layout">
  <!-- Sidebar filtros -->
  <aside class="filters-sidebar">
    <div class="sidebar-header">
      <mat-icon>task_alt</mat-icon>
      <h2>Tareas</h2>
    </div>
    <div class="filters-section">
      <h3>
        <mat-icon>filter_list</mat-icon>
        Filtros rápidos
      </h3>
      <p class="filters-hint">Distintos a las tarjetas: por fecha y asignación.</p>
      <button
        class="filter-item"
        [class.active]="quickFilter() === 'all'"
        (click)="allFilter()"
      >
        <span class="filter-icon all"></span>
        <span class="filter-text">Todas</span>
        <span class="filter-badge filter-badge-empty"></span>
      </button>
      <button
        class="filter-item"
        [class.active]="quickFilter() === 'hoy'"
        (click)="setQuickFilter('hoy')"
      >
        <span class="filter-icon hoy"></span>
        <span class="filter-text">Hoy</span>
        <span class="filter-badge">{{ hoyCount() }}</span>
      </button>
      <button
        class="filter-item"
        [class.active]="quickFilter() === 'por-vencer'"
        (click)="setQuickFilter('por-vencer')"
      >
        <span class="filter-icon por-vencer"></span>
        <span class="filter-text">Por vencer</span>
        <span class="filter-badge">{{ dueSoonCount() }}</span>
      </button>
      <button
        class="filter-item"
        [class.active]="quickFilter() === 'esta-semana'"
        (click)="setQuickFilter('esta-semana')"
      >
        <span class="filter-icon esta-semana"></span>
        <span class="filter-text">Esta semana</span>
        <span class="filter-badge">{{ estaSemanaCount() }}</span>
      </button>
      <button
        class="filter-item"
        [class.active]="quickFilter() === 'alta'"
        (click)="setQuickFilter('alta')"
      >
        <span class="filter-icon alta"></span>
        <span class="filter-text">Alta prioridad</span>
        <span class="filter-badge">{{ altaCount() }}</span>
      </button>
      <button
        class="filter-item"
        [class.active]="quickFilter() === 'sin-asignar'"
        (click)="setQuickFilter('sin-asignar')"
      >
        <span class="filter-icon sin-asignar"></span>
        <span class="filter-text">Sin asignar</span>
        <span class="filter-badge">{{ sinAsignarCount() }}</span>
      </button>
    </div>
    <div class="filters-section">
      <h3>Estado</h3>
      <p class="filters-hint">Selecciona varios para combinar (OR).</p>
      @if (statusFilter().length) {
        <button type="button" class="clear-filters" (click)="clearStatusFilter()">Limpiar estado</button>
      }
      <div class="checkbox-group">
        @for (opt of statusFilterOptions; track opt.value) {
          <label class="checkbox-item">
            <input
              type="checkbox"
              [checked]="isStatusChecked(opt.value)"
              (change)="toggleStatus(opt.value)"
            />
            <span>{{ opt.label }}</span>
          </label>
        }
      </div>
    </div>
    <div class="filters-section">
      <h3>Prioridad</h3>
      <p class="filters-hint">Selecciona varias para combinar (OR).</p>
      @if (priorityFilter().length) {
        <button type="button" class="clear-filters" (click)="clearPriorityFilter()">Limpiar prioridad</button>
      }
      <div class="checkbox-group">
        @for (p of priorities; track p.id) {
          <label class="checkbox-item">
            <input
              type="checkbox"
              [checked]="isPriorityChecked(p.value)"
              (change)="togglePriority(p.value)"
            />
            <span>{{ p.name }}</span>
          </label>
        }
      </div>
    </div>
  </aside>

  <!-- Área principal -->
  <main class="task-main">
    <div class="main-toolbar">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar</mat-label>
        <input
          matInput
          type="search"
          [ngModel]="searchText()"
          (ngModelChange)="searchText.set($event)"
          placeholder="Buscar por texto, ID o responsable..."
        />
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>
      <mat-button-toggle-group [value]="viewMode()" (valueChange)="viewMode.set($event)" class="view-toggle">
        <mat-button-toggle value="list">
          <mat-icon>view_list</mat-icon>
          <span class="view-toggle-label">Lista</span>
        </mat-button-toggle>
        <mat-button-toggle value="board">
          <mat-icon>view_column</mat-icon>
          <span class="view-toggle-label">Tablero</span>
        </mat-button-toggle>
      </mat-button-toggle-group>
      <div class="toolbar-actions">
        <button mat-stroked-button [disabled]="!connectivity.isOnline()" [matTooltip]="!connectivity.isOnline() ? 'Requiere conexión' : ''">
          <mat-icon>upload</mat-icon>
          Exportar
        </button>
        <button mat-flat-button color="primary" [disabled]="!connectivity.isOnline()" [matTooltip]="!connectivity.isOnline() ? 'Requiere conexión para crear tareas' : ''" (click)="openNewTask()">
          <mat-icon>add</mat-icon>
          Nueva tarea
        </button>
      </div>
    </div>

    <div class="kpi-strip animate-stagger">
      <button type="button" class="kpi-card kpi-card-clickable kpi-inprogress" [class.active]="isStatusFilterActive('En Progreso')" (click)="applyStatusFilter('En Progreso')">
        <span class="kpi-value">{{ inProgressCount() }}</span>
        <span class="kpi-label">En progreso</span>
      </button>
      <button type="button" class="kpi-card kpi-card-clickable kpi-waiting" [class.active]="isStatusFilterActive('En Espera')" (click)="applyStatusFilter('En Espera')">
        <span class="kpi-value">{{ enEsperaCount() }}</span>
        <span class="kpi-label">En espera</span>
      </button>
      <button type="button" class="kpi-card kpi-card-clickable kpi-danger" [class.active]="isStatusFilterActive('Vencida')" (click)="applyStatusFilter('Vencida')">
        <span class="kpi-value">{{ overdueCount() }}</span>
        <span class="kpi-label">Vencidas</span>
      </button>
      <button type="button" class="kpi-card kpi-card-clickable kpi-success" [class.active]="isStatusFilterActive('Completada')" (click)="applyStatusFilter('Completada')">
        <span class="kpi-value">{{ completedCount() }}</span>
        <span class="kpi-label">Completadas</span>
      </button>
      <button type="button" class="kpi-card kpi-card-clickable kpi-liberadas" [class.active]="isStatusFilterActive('Liberada')" (click)="applyStatusFilter('Liberada')">
        <span class="kpi-value">{{ liberadasCount() }}</span>
        <span class="kpi-label">Liberadas</span>
      </button>
    </div>

    <div class="results-header">
      <span class="results-count">Resultados ({{ displayedTasks().length }})</span>
      <mat-form-field appearance="outline" class="sort-field">
        <mat-label>Orden</mat-label>
        <mat-select [value]="sortOrder()" (valueChange)="sortOrder.set($event)">
          <mat-option value="default">Por defecto</mat-option>
          <mat-option value="vencidas-primero">Vencidas primero</mat-option>
          <mat-option value="fecha">Por fecha vencimiento</mat-option>
          <mat-option value="estado">Por estado</mat-option>
          <mat-option value="prioridad">Por prioridad</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    @if (displayedTasks().length === 0) {
      <app-empty-state
        icon="search_off"
        title="Sin resultados"
        message="Ajusta los filtros o crea una nueva tarea"
      />
    } @else if (viewMode() === 'board') {
      <app-kanban-board
        [tasks]="displayedTasks()"
        [draggable]="true"
        class="animate-stagger"
      />
    } @else {
      <div class="task-cards-list animate-stagger">
        @for (task of displayedTasks(); track task.id) {
          <a class="task-card-link" [routerLink]="['/tareas', task.id]">
            <div
              class="task-card-v2"
              [class.vencida]="getEffectiveStatus(task) === 'Vencida'"
              [class.por-vencer]="task.riskIndicator === 'por-vencer' && getEffectiveStatus(task) !== 'Vencida'"
            >
              <span class="task-card-prio-dot" [attr.data-prio]="task.priority"></span>
              <app-avatar
                class="task-card-avatar"
                [name]="task.assignee || 'Sin asignar'"
                [avatarUrl]="getUserById(task.assigneeId)?.avatarUrl ?? getUserByName(task.assignee)?.avatarUrl"
                [size]="36"
              />
              <div class="task-card-body">
                <div class="task-title-row">
                  <h4 class="task-title">{{ task.title }}</h4>
                  <div class="task-relation-indicators">
                    @if (task.parentTaskId) {
                      <mat-icon class="rel-icon subtask" matTooltip="Subtarea">subdirectory_arrow_right</mat-icon>
                    }
                    @if (taskService.getSubtasks(task.id).length) {
                      <span class="rel-chip" matTooltip="{{ taskService.getSubtasks(task.id).length }} subtarea(s)">{{ taskService.getSubtasks(task.id).length }} subt.</span>
                    }
                    @if (taskService.isBlocked(task.id)) {
                      <mat-icon class="rel-icon blocked" matTooltip="Bloqueada">block</mat-icon>
                    }
                  </div>
                </div>
                <p class="task-details">
                  {{ task.folio }} • {{ task.assignee || 'Sin asignar' }} • {{ task.priority }} •
                  {{ getEffectiveStatus(task) === 'Vencida' ? 'Venció' : task.riskIndicator === 'por-vencer' ? 'Por vencer' : (task.dueDate | date: 'dd/MM/yyyy') }}
                </p>
                <div class="task-card-footer">
                  <span
                    class="status-badge"
                    [class.vencida]="getEffectiveStatus(task) === 'Vencida'"
                    [class.en-progreso]="getEffectiveStatus(task) === 'En Progreso'"
                    [class.pendiente]="getEffectiveStatus(task) === 'Pendiente'"
                    [class.en-espera]="getEffectiveStatus(task) === 'En Espera'"
                    [class.rechazada]="getEffectiveStatus(task) === 'Rechazada'"
                    [class.completada]="getEffectiveStatus(task) === 'Completada'"
                    [class.liberada]="getEffectiveStatus(task) === 'Liberada'"
                    [class.cancelada]="getEffectiveStatus(task) === 'Cancelada'"
                  >
                    {{ getEffectiveStatus(task) | uppercase }}
                  </span>
                  <div class="task-card-right">
                    <span class="task-due-label">
                      {{ getEffectiveStatus(task) === 'Vencida' ? 'Venció' : (task.dueDate | date: 'dd MMM') }}
                    </span>
                    <div class="task-actions">
                      <button mat-icon-button type="button" (click)="$event.preventDefault(); $event.stopPropagation()" tabindex="-1">
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button mat-icon-button type="button" (click)="$event.preventDefault(); $event.stopPropagation()" tabindex="-1">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button type="button" (click)="$event.preventDefault(); $event.stopPropagation()" tabindex="-1">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        }
      </div>

      <div class="pagination">
        <span class="pagination-info">1-{{ displayedTasks().length }} de {{ displayedTasks().length }}</span>
        <div class="pagination-controls">
          <button mat-icon-button disabled><mat-icon>chevron_left</mat-icon></button>
          <span class="page-num">1</span>
          <button mat-icon-button disabled><mat-icon>chevron_right</mat-icon></button>
        </div>
      </div>
    }
  </main>
</div>
