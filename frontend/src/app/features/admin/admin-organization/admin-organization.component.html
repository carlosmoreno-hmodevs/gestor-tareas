<app-page-header
  title="Organización"
  subtitle="Estructura de unidades organizacionales del tenant"
  icon="account_tree"
/>
<mat-card>
  <mat-card-header>
    <mat-card-title>Árbol de unidades</mat-card-title>
    <mat-card-subtitle>Jerarquía de regiones, tiendas, departamentos</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <div class="org-tree">
      @for (node of orgTree(); track node.id; let i = $index; let lastRoot = $last) {
        <div class="org-tree-rec">
          <ng-container *ngTemplateOutlet="treeNode; context: { node: node, depth: 0, isLast: lastRoot, parentIsLast: [] }" />
        </div>
      }
    </div>
  </mat-card-content>
</mat-card>

<ng-template #treeNode let-node="node" let-depth="depth" let-isLast="isLast" let-parentIsLast="parentIsLast">
  <div class="org-tree-node" [class.org-tree-node--root]="depth === 0">
    <span class="org-tree-connector">
      @if (depth > 0) {
        @for (p of parentIsLast; track $index) {
          <span class="org-tree-vline" [class.org-tree-vline--hidden]="p">│</span>
        }
        <span class="org-tree-branch">{{ isLast ? '└' : '├' }}──</span>
      } @else {
        <span class="org-tree-root-icon">◆</span>
      }
    </span>
    <span class="org-node-content">
      <span class="org-node-name">{{ node.name }}</span>
      @if (node.code) { <span class="org-node-code">({{ node.code }})</span> }
    </span>
    <button mat-icon-button (click)="deactivate(node)" matTooltip="Desactivar" class="org-node-btn">
      <mat-icon>remove_circle_outline</mat-icon>
    </button>
  </div>
  @if (node.children?.length) {
    <div class="org-tree-children">
      @for (child of node.children; track child.id; let i = $index; let lastChild = $last) {
        <ng-container *ngTemplateOutlet="treeNode; context: { node: child, depth: depth + 1, isLast: lastChild, parentIsLast: [...parentIsLast, isLast] }" />
      }
    </div>
  }
</ng-template>

<mat-card class="add-section">
  <mat-card-header>
    <mat-card-title>Agregar unidad</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <div class="add-form">
      <mat-form-field appearance="outline">
        <mat-label>Nombre</mat-label>
        <input matInput [(ngModel)]="newName" placeholder="Ej: Tienda Centro" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Código</mat-label>
        <input matInput [(ngModel)]="newCode" placeholder="Ej: TC" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Tipo</mat-label>
        <mat-select [(ngModel)]="newTypeKey">
          @for (t of orgUnitTypes(); track t.id) {
            <mat-option [value]="t.key">{{ t.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Unidad padre</mat-label>
        <mat-select [(ngModel)]="newParentId">
          <mat-option value="">(Raíz)</mat-option>
          @for (node of orgTree(); track node.id) {
            @for (item of flattenForSelect(node, 0); track item.id) {
              <mat-option [value]="item.id">{{ item.prefix }}{{ item.name }}</mat-option>
            }
          }
        </mat-select>
      </mat-form-field>
      <button mat-flat-button color="primary" (click)="addOrgUnit()" [disabled]="!newName.trim()">
        <mat-icon>add</mat-icon>
        Agregar
      </button>
    </div>
  </mat-card-content>
</mat-card>

<mat-card class="users-section">
  <mat-card-header>
    <mat-card-title>Usuarios por unidad</mat-card-title>
    <mat-card-subtitle>
      Consulta qué usuarios pertenecen a cada unidad. Para modificar la unidad de algún usuario, ve a Usuarios y edita su perfil.
      <a routerLink="/admin/usuarios" class="link-usuarios">Ir a Usuarios →</a>
    </mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <div class="users-by-unit">
      <p class="users-instruction">Para asignar o cambiar la unidad organizativa de un usuario, ve a <a routerLink="/admin/usuarios">Usuarios</a> y edita el perfil del usuario.</p>
      <mat-form-field appearance="outline">
        <mat-label>Ver unidad</mat-label>
        <mat-select [ngModel]="selectedUnitForUsers()" (ngModelChange)="selectedUnitForUsers.set($event)">
          <mat-option value="">Seleccionar unidad</mat-option>
          @for (item of flatOrgUnits(); track item.id) {
            <mat-option [value]="item.id">{{ item.prefix }}{{ item.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      @if (selectedUnitForUsers()) {
        <div class="unit-users-panel">
          <span class="section-label">Usuarios en esta unidad:</span>
          @if (usersInSelectedUnit().length === 0) {
            <p class="empty-hint">Ningún usuario asignado. Para asignar usuarios a esta unidad, ve a <a routerLink="/admin/usuarios">Usuarios</a> y edita el perfil de cada usuario.</p>
          } @else {
            <ul class="user-chips readonly">
              @for (u of usersInSelectedUnit(); track u.membershipId) {
                <li>
                  <mat-icon class="user-icon">person</mat-icon>
                  <span class="user-chip">{{ u.userName }}</span>
                </li>
              }
            </ul>
          }
        </div>
      }
    </div>
  </mat-card-content>
</mat-card>
