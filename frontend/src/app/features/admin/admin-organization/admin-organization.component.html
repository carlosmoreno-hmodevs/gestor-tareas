<app-page-header
  title="Organización"
  subtitle="Estructura de unidades organizacionales del tenant"
  icon="account_tree"
/>
<mat-card>
  <mat-card-header>
    <mat-card-title>Árbol de unidades</mat-card-title>
    <mat-card-subtitle>Jerarquía de regiones, tiendas, departamentos</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <div class="org-tree">
      @for (node of orgTree(); track node.id) {
        <div class="org-tree-rec">
          <ng-container *ngTemplateOutlet="treeNode; context: { node: node, depth: 0 }" />
        </div>
      }
    </div>
  </mat-card-content>
</mat-card>

<ng-template #treeNode let-node="node" let-depth="depth">
  <div class="org-tree-node" [style.padding-left.rem]="depth * 1.5">
    <span class="org-node-name">{{ node.name }}</span>
    @if (node.code) { <span class="org-node-code">({{ node.code }})</span> }
    <button mat-icon-button (click)="deactivate(node)" matTooltip="Desactivar" class="org-node-btn">
      <mat-icon>remove_circle_outline</mat-icon>
    </button>
  </div>
  @for (child of node.children; track child.id) {
    <ng-container *ngTemplateOutlet="treeNode; context: { node: child, depth: depth + 1 }" />
  }
</ng-template>

<mat-card class="add-section">
  <mat-card-header>
    <mat-card-title>Agregar unidad</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <div class="add-form">
      <mat-form-field appearance="outline">
        <mat-label>Nombre</mat-label>
        <input matInput [(ngModel)]="newName" placeholder="Ej: Tienda Centro" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Código</mat-label>
        <input matInput [(ngModel)]="newCode" placeholder="Ej: TC" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Tipo</mat-label>
        <mat-select [(ngModel)]="newTypeKey">
          @for (t of orgUnitTypes(); track t.id) {
            <mat-option [value]="t.key">{{ t.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Unidad padre</mat-label>
        <mat-select [(ngModel)]="newParentId">
          <mat-option value="">(Raíz)</mat-option>
          @for (node of orgTree(); track node.id) {
            @for (item of flattenForSelect(node, 0); track item.id) {
              <mat-option [value]="item.id">{{ item.prefix }}{{ item.name }}</mat-option>
            }
          }
        </mat-select>
      </mat-form-field>
      <button mat-flat-button color="primary" (click)="addOrgUnit()" [disabled]="!newName.trim()">
        <mat-icon>add</mat-icon>
        Agregar
      </button>
    </div>
  </mat-card-content>
</mat-card>

<mat-card class="users-section">
  <mat-card-header>
    <mat-card-title>Usuarios por unidad</mat-card-title>
    <mat-card-subtitle>Asigna usuarios a cada unidad organizativa</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <div class="users-by-unit">
      <mat-form-field appearance="outline">
        <mat-label>Unidad</mat-label>
        <mat-select [ngModel]="selectedUnitForUsers()" (ngModelChange)="selectedUnitForUsers.set($event)">
          <mat-option value="">Seleccionar unidad</mat-option>
          @for (item of flatOrgUnits(); track item.id) {
            <mat-option [value]="item.id">{{ item.prefix }}{{ item.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      @if (selectedUnitForUsers()) {
        <div class="unit-users-panel">
          <div class="unit-users-list">
            <span class="section-label">Usuarios en esta unidad:</span>
            @if (usersInSelectedUnit().length === 0) {
              <p class="empty-hint">Ningún usuario asignado. Añade uno abajo.</p>
            } @else {
              <ul class="user-chips">
                @for (u of usersInSelectedUnit(); track u.membershipId) {
                  <li>
                    <span class="user-chip">{{ u.userName }}</span>
                    <button mat-icon-button type="button" (click)="removeUserFromUnit(u.membershipId)" matTooltip="Quitar de unidad" aria-label="Quitar">
                      <mat-icon>close</mat-icon>
                    </button>
                  </li>
                }
              </ul>
            }
          </div>
          <div class="add-user-form">
            <mat-form-field appearance="outline">
              <mat-label>Añadir usuario</mat-label>
              <mat-select [(ngModel)]="newUserToAdd">
                <mat-option value="">Seleccionar</mat-option>
                @for (u of usersAvailableForUnit(); track u.id) {
                  <mat-option [value]="u.id">{{ u.name }}</mat-option>
                }
              </mat-select>
              @if (usersAvailableForUnit().length === 0 && usersInSelectedUnit().length > 0) {
                <mat-hint>Todos los usuarios ya están asignados</mat-hint>
              }
            </mat-form-field>
            <button mat-flat-button color="primary" (click)="addUserToUnit()" [disabled]="!newUserToAdd">
              <mat-icon>person_add</mat-icon>
              Añadir
            </button>
          </div>
        </div>
      }
    </div>
  </mat-card-content>
</mat-card>
