<app-page-header
  title="Usuarios"
  subtitle="Gestiona usuarios, roles y equipos"
  icon="people"
/>

<mat-card>
  <mat-card-header>
    <mat-card-title>Lista de usuarios</mat-card-title>
    <button
      mat-flat-button
      color="primary"
      [disabled]="!connectivity.isOnline()"
      [matTooltip]="!connectivity.isOnline() ? 'Requires connection' : ''"
      (click)="openCreate()"
    >
      <mat-icon>add</mat-icon>
      <span class="btn-label">Agregar usuario</span>
    </button>
  </mat-card-header>
  <mat-card-content>
    @if (isMobile()) {
      <div class="user-cards">
        @for (u of users(); track u.id) {
          <div class="user-card">
            <div class="user-card-main">
              <app-avatar [name]="u.name" [size]="44" />
              <div class="user-card-info">
                <span class="user-card-name">{{ u.name }}</span>
                <span class="user-card-email">{{ u.email }}</span>
                <div class="user-card-meta">
                  <span class="user-card-team">{{ getTeamName(u.teamId) }}</span>
                  <span class="status-chip" [class.inactive]="!u.isActive">
                    {{ u.isActive ? 'Activo' : 'Inactivo' }}
                  </span>
                </div>
              </div>
            </div>
            <button mat-icon-button [matMenuTriggerFor]="userCardMenu" (click)="menuUser.set(u)" class="user-card-menu">
              <mat-icon>more_vert</mat-icon>
            </button>
          </div>
        }
      </div>
      <mat-menu #userCardMenu="matMenu">
        @if (menuUser(); as u) {
          <button mat-menu-item (click)="openEdit(u)">
            <mat-icon>edit</mat-icon>
            <span>Editar</span>
          </button>
          <button mat-menu-item (click)="toggleActive(u)">
            <mat-icon>{{ u.isActive ? 'person_off' : 'person_add' }}</mat-icon>
            <span>{{ u.isActive ? 'Desactivar' : 'Activar' }}</span>
          </button>
          <button mat-menu-item disabled matTooltip="Mock">
            <mat-icon>lock_reset</mat-icon>
            <span>Reset password</span>
          </button>
        }
      </mat-menu>
    } @else {
    <table mat-table [dataSource]="users()" class="full-width">
      <ng-container matColumnDef="avatar">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let u">
          <app-avatar [name]="u.name" [size]="36" />
        </td>
      </ng-container>
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nombre</th>
        <td mat-cell *matCellDef="let u">{{ u.name }}</td>
      </ng-container>
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef>Email</th>
        <td mat-cell *matCellDef="let u">{{ u.email }}</td>
      </ng-container>
      <ng-container matColumnDef="team">
        <th mat-header-cell *matHeaderCellDef>Equipo</th>
        <td mat-cell *matCellDef="let u">{{ getTeamName(u.teamId) }}</td>
      </ng-container>
      <ng-container matColumnDef="unit">
        <th mat-header-cell *matHeaderCellDef>Unidad</th>
        <td mat-cell *matCellDef="let u" [matTooltip]="getUnitNames(u.id) !== 'â€”' ? getUnitNames(u.id) : ''">
          <span class="unit-cell">{{ getUnitNames(u.id) }}</span>
        </td>
      </ng-container>
      <ng-container matColumnDef="role">
        <th mat-header-cell *matHeaderCellDef>Rol</th>
        <td mat-cell *matCellDef="let u">{{ getRoleName(u.roleId) }}</td>
      </ng-container>
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Estatus</th>
        <td mat-cell *matCellDef="let u">
          <span class="status-chip" [class.inactive]="!u.isActive">
            {{ u.isActive ? 'Activo' : 'Inactivo' }}
          </span>
        </td>
      </ng-container>
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let u">
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="openEdit(u)">
              <mat-icon>edit</mat-icon>
              <span>Editar</span>
            </button>
            <button mat-menu-item (click)="toggleActive(u)">
              <mat-icon>{{ u.isActive ? 'person_off' : 'person_add' }}</mat-icon>
              <span>{{ u.isActive ? 'Desactivar' : 'Activar' }}</span>
            </button>
            <button mat-menu-item disabled matTooltip="Mock">
              <mat-icon>lock_reset</mat-icon>
              <span>Reset password</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="['avatar','name','email','team','unit','role','status','actions']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['avatar','name','email','team','unit','role','status','actions']"></tr>
    </table>
    }
  </mat-card-content>
</mat-card>
