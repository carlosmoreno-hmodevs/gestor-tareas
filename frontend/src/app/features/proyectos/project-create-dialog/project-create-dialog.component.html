<h2 mat-dialog-title>Nuevo proyecto</h2>
<mat-dialog-content class="project-form-content">
  <form [formGroup]="form">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Nombre del proyecto *</mat-label>
      <input matInput formControlName="name" placeholder="Nombre del proyecto" />
      @if (form.get('name')?.hasError('required') && form.get('name')?.touched) {
        <mat-error>Name is required</mat-error>
      }
      @if (form.get('name')?.hasError('minlength') && form.get('name')?.touched) {
        <mat-error>Minimum 2 characters</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Owner / Responsable *</mat-label>
      <mat-select formControlName="ownerId">
        <mat-option value="">—</mat-option>
        @for (u of teamUsers; track u.id) {
          <mat-option [value]="u.id">{{ u.name }}</mat-option>
        }
      </mat-select>
      @if (form.get('ownerId')?.hasError('required') && form.get('ownerId')?.touched) {
        <mat-error>Owner is required</mat-error>
      }
    </mat-form-field>

    <div class="image-section">
      <label class="section-label">Imagen del proyecto</label>
      @if (imagePreview) {
        <div class="image-preview">
          <img [src]="imagePreview" alt="Preview" />
          <button mat-icon-button type="button" (click)="clearImage()" aria-label="Quitar imagen">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      } @else {
        <div class="image-upload" (click)="imageInput.click()">
          <input #imageInput type="file" accept="image/png,image/jpeg,image/jpg,image/webp" hidden (change)="onImageSelect($event)" />
          <mat-icon>add_photo_alternate</mat-icon>
          <span>Seleccionar imagen (png, jpg, webp)</span>
        </div>
      }
    </div>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Descripción</mat-label>
      <textarea matInput formControlName="description" rows="3"></textarea>
    </mat-form-field>

    <div class="row-fields">
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Estado</mat-label>
        <mat-select formControlName="status">
          <mat-option value="">Sin estado</mat-option>
          @for (s of statuses; track s.id) {
            <mat-option [value]="s.value">{{ s.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Prioridad</mat-label>
        <mat-select formControlName="priority">
          <mat-option value="">—</mat-option>
          @for (p of priorities; track p.id) {
            <mat-option [value]="p.value">{{ p.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <div class="row-fields">
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Fecha inicio</mat-label>
        <input matInput [matDatepicker]="startPicker" formControlName="startDate" />
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker [startAt]="minDate"></mat-datepicker>
      </mat-form-field>
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Fecha objetivo</mat-label>
        <input matInput [matDatepicker]="duePicker" formControlName="dueDate" />
        <mat-datepicker-toggle matSuffix [for]="duePicker"></mat-datepicker-toggle>
        <mat-datepicker #duePicker [startAt]="minDate"></mat-datepicker>
      </mat-form-field>
    </div>
    @if (form.hasError('dueBeforeStart') && form.get('dueDate')?.touched) {
      <p class="form-error">Due date cannot be before start date</p>
    }

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Cliente / Área / Departamento</mat-label>
      <input matInput formControlName="clientArea" placeholder="Ej: Operaciones, Logística" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Miembros del equipo</mat-label>
      <mat-select formControlName="memberIds" multiple>
        @for (u of users; track u.id) {
          <mat-option [value]="u.id">{{ u.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Etiquetas</mat-label>
      <mat-chip-grid #chipGrid>
        @for (tag of form.get('tags')?.value ?? []; track tag) {
          <mat-chip-row (removed)="removeTag(tag)">
            {{ tag }}
            <button matChipRemove><mat-icon>cancel</mat-icon></button>
          </mat-chip-row>
        }
        <input placeholder="Añadir etiqueta..." [matChipInputFor]="chipGrid" [matChipInputSeparatorKeyCodes]="[13, 188]" (matChipInputTokenEnd)="addTag($event)" />
      </mat-chip-grid>
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Presupuesto / Costo estimado</mat-label>
      <input matInput type="number" formControlName="budget" placeholder="0" />
    </mat-form-field>

    <div class="files-section">
      <label class="section-label">Archivos iniciales</label>
      <div class="files-upload" (click)="filesInput.click()">
        <input #filesInput type="file" multiple hidden (change)="onFilesSelect($event)" />
        <mat-icon>cloud_upload</mat-icon>
        <span>Seleccionar archivos (solo metadata)</span>
      </div>
      @if (initialFiles.length) {
        <ul class="file-list">
          @for (f of initialFiles; track f.name + f.size; let i = $index) {
            <li>
              <mat-icon>description</mat-icon>
              <span>{{ f.name }}</span>
              <button mat-icon-button type="button" (click)="removeFile(i)">
                <mat-icon>close</mat-icon>
              </button>
            </li>
          }
        </ul>
      }
    </div>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Observaciones</mat-label>
      <textarea matInput formControlName="observations" rows="2"></textarea>
    </mat-form-field>
  </form>
</mat-dialog-content>
<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()">Cancelar</button>
  <button
    mat-flat-button
    color="primary"
    (click)="save()"
    [disabled]="form.invalid || !connectivity.isOnline()"
    [matTooltip]="!connectivity.isOnline() ? 'Requires connection' : ''"
  >
    Guardar
  </button>
</mat-dialog-actions>
