@let p = project();
@if (!p) {
  <div class="project-not-found">
    <h2>Proyecto no encontrado</h2>
    <button mat-button (click)="goBack()">Volver a proyectos</button>
  </div>
} @else if (!isProjectInScope()) {
  <div class="project-not-found">
    <h2>Proyecto fuera del alcance</h2>
    <p>Este proyecto no pertenece a la organización seleccionada. Cambia la organización o vuelve a la lista.</p>
    <button mat-button (click)="goBack()">Volver a proyectos</button>
  </div>
} @else {
  <nav class="breadcrumb">
    <a [routerLink]="['/proyectos']">Proyectos</a>
    <mat-icon>chevron_right</mat-icon>
    <span>{{ p.name }}</span>
  </nav>

  <div class="project-detail-layout">
    <div class="project-main">
  <header class="project-detail-header animate-fade-in">
    <div class="header-media">
      @if (p.image?.previewUrl) {
        <img [src]="p.image!.previewUrl" alt="" class="project-cover" />
      } @else {
        <div class="project-avatar">
          <mat-icon>folder</mat-icon>
        </div>
      }
    </div>
    <div class="header-content">
      <div class="header-top">
        <h1 class="project-title">{{ p.name }}</h1>
        <div class="header-actions-row">
          <button
            mat-stroked-button
            color="primary"
            class="add-task-header-btn"
            [disabled]="!connectivity.isOnline()"
            [matTooltip]="!connectivity.isOnline() ? 'Requiere conexión' : ''"
            (click)="openAddExistingTasks()"
          >
            <mat-icon>link</mat-icon>
            Agregar tareas
          </button>
          <button
            mat-flat-button
            color="primary"
            class="add-task-header-btn"
            [disabled]="!connectivity.isOnline()"
            [matTooltip]="!connectivity.isOnline() ? 'Requiere conexión' : ''"
            (click)="openAddTask()"
          >
            <mat-icon>add</mat-icon>
            Nueva tarea
          </button>
          <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Más acciones">
            <mat-icon>more_vert</mat-icon>
          </button>
        </div>
        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="onMenuAction('edit')">
            <mat-icon>edit</mat-icon>
            <span>Editar proyecto</span>
          </button>
          <button mat-menu-item (click)="onMenuAction('export')">
            <mat-icon>download</mat-icon>
            <span>Exportar</span>
          </button>
          <button mat-menu-item (click)="onMenuAction('archive')">
            <mat-icon>archive</mat-icon>
            <span>Archivar</span>
          </button>
        </mat-menu>
      </div>
      <div class="header-chips">
        @if (p.initiativeId) {
          <span class="chip initiative">Iniciativa {{ p.initiativeId }}</span>
        }
        @if (p.status) {
          <span class="chip status">{{ p.status }}</span>
        }
        @if (p.clientArea) {
          <span class="chip">{{ p.clientArea }}</span>
        }
        @if (p.dueDate) {
          <span class="chip">Vence: {{ p.dueDate | dateFormat: 'short' }}</span>
        }
        @if (!p.initiativeId && !p.status && !p.clientArea && !p.dueDate) {
          <span class="chip muted">—</span>
        }
      </div>
      <div class="header-owner">
        <app-avatar [name]="p.owner" [size]="28" />
        <span>{{ p.owner }}@if (getUserById(p.ownerId)?.position) { · {{ getUserById(p.ownerId)?.position }} }</span>
      </div>
    </div>
  </header>

  <section class="kpis-strip animate-fade-in">
    <button type="button" class="kpi-card kpi-card-clickable kpi-inprogress" (click)="goToTasksWithFilter('En Progreso')">
      <span class="kpi-value">{{ kpis().tasksInProgress }}</span>
      <span class="kpi-label">En progreso</span>
    </button>
    <button type="button" class="kpi-card kpi-card-clickable kpi-waiting" (click)="goToTasksWithFilter('En Espera')">
      <span class="kpi-value">{{ kpis().tasksEnEspera }}</span>
      <span class="kpi-label">En espera</span>
    </button>
    <button type="button" class="kpi-card kpi-card-clickable kpi-danger" [class.focus-vencidas-pulse]="focusVencidasActive()" (click)="goToTasksWithFilter('Vencida')">
      <span class="kpi-value">{{ kpis().tasksOverdue }}</span>
      <span class="kpi-label">Vencidas</span>
    </button>
    <button type="button" class="kpi-card kpi-card-clickable kpi-success" (click)="goToTasksWithFilter('Completada')">
      <span class="kpi-value">{{ kpis().completedTasks }}</span>
      <span class="kpi-label">Completadas</span>
    </button>
    <button type="button" class="kpi-card kpi-card-clickable kpi-liberadas" (click)="goToTasksWithFilter('Liberada')">
      <span class="kpi-value">{{ kpis().liberadasTasks }}</span>
      <span class="kpi-label">Liberadas</span>
    </button>
    <button type="button" class="kpi-card kpi-card-clickable kpi-progress" (click)="goToTasksWithFilter('todas')">
      <span class="kpi-value">{{ kpis().progressPercent }}%</span>
      <span class="kpi-label">Progreso</span>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" [style.width.%]="kpis().progressPercent"></div>
      </div>
    </button>
  </section>

  <mat-tab-group class="project-tabs" [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="selectedTabIndex.set($event)">
    <mat-tab label="Resumen">
      <div class="tab-content overview-tab">
        <div class="overview-grid-cards">
          <mat-card class="overview-card">
            <mat-card-header>
              <mat-card-title>Descripción</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (p.description) {
                <p class="description-text">{{ p.description }}</p>
              } @else {
                <p class="empty-state">Sin descripción</p>
              }
            </mat-card-content>
          </mat-card>
          <mat-card class="overview-card">
            <mat-card-header>
              <mat-card-title>Equipo</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (teamMemberStats().length) {
                <div class="team-cards">
                  @for (s of teamMemberStats(); track s.userId) {
                    <div class="team-member-card" [class.effectiveness-high]="s.effectivenessLevel === 'high'" [class.effectiveness-medium]="s.effectivenessLevel === 'medium'" [class.effectiveness-low]="s.effectivenessLevel === 'low'">
                      <div class="team-card-header">
                        <app-avatar [name]="s.name" [size]="44" />
                        <div class="team-card-info">
                          <span class="member-name">{{ s.name }}</span>
                          @if (s.position) {
                            <span class="member-position">{{ s.position }}</span>
                          }
                        </div>
                      </div>
                      <div class="team-card-stats">
                        <span class="stat-liberadas">{{ s.liberadas }} / {{ s.total }} liberadas</span>
                        <span class="stat-effectiveness" [class.eff-high]="s.effectivenessLevel === 'high'" [class.eff-medium]="s.effectivenessLevel === 'medium'" [class.eff-low]="s.effectivenessLevel === 'low'">{{ s.effectiveness }}% efectividad</span>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <p class="empty-state">Sin miembros</p>
              }
            </mat-card-content>
          </mat-card>
          @if (p.initiativeId) {
            <mat-card class="overview-card">
              <mat-card-header>
                <mat-card-title>Datos del proyecto</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="key-dates">
                  <div class="key-date-row">
                    <mat-icon>label</mat-icon>
                    <div>
                      <span class="label">Iniciativa</span>
                      <span class="value">{{ p.initiativeId }}</span>
                    </div>
                  </div>
                  <div class="key-date-row">
                    <mat-icon>person</mat-icon>
                    <div>
                      <span class="label">Responsable</span>
                      <span class="value">{{ p.owner }}@if (getUserById(p.ownerId)?.position) { · {{ getUserById(p.ownerId)?.position }} }</span>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          }
          <mat-card class="overview-card">
            <mat-card-header>
              <mat-card-title>Fechas clave</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="key-dates">
                <div class="key-date-row">
                  <mat-icon>event</mat-icon>
                  <div>
                    <span class="label">Inicio</span>
                    <span class="value">{{ p.startDate ? (p.startDate | dateFormat: 'short') : '—' }}</span>
                  </div>
                </div>
                <div class="key-date-row">
                  <mat-icon>flag</mat-icon>
                  <div>
                    <span class="label">Objetivo</span>
                    <span class="value">{{ p.dueDate ? (p.dueDate | dateFormat: 'short') : '—' }}</span>
                  </div>
                </div>
                <div class="key-date-row">
                  <mat-icon>update</mat-icon>
                  <div>
                    <span class="label">Última actualización</span>
                    <span class="value">{{ p.lastUpdatedAt ? (p.lastUpdatedAt | relativeTime) : '—' }}</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
          @if (isFerretero() && p.templateId) {
            <mat-card class="overview-card template-card">
              <mat-card-header>
                <mat-card-title>Plantilla aplicada</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <p class="template-name">{{ p.templateName ?? p.templateId }}</p>
                @if (showGenerateTemplateButton()) {
                  <button
                    mat-stroked-button
                    color="primary"
                    [disabled]="!connectivity.isOnline()"
                    (click)="generateTemplateTasks()"
                  >
                    Generar tareas del template
                  </button>
                } @else {
                  <p class="template-generated">Tareas generadas: {{ templateTasks().length }} total</p>
                }
              </mat-card-content>
            </mat-card>
            @if (isFerretero() && p.templateId && templateTasks().length) {
              <mat-card class="overview-card skeleton-card">
                <mat-card-header>
                  <mat-card-title>Esqueleto de tareas</mat-card-title>
                  <mat-card-subtitle>Total: {{ templateTasks().length }} · Completadas: {{ templateTasksCompletadas() }} · {{ uiCopy.statusLabel('Vencida') }}: {{ templateTasksVencidas() }} · Bloqueadas: {{ templateTasksBloqueadas() }}</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <ul class="template-tasks-list">
                    @for (t of templateTasks(); track t.id) {
                      <li class="template-task-item" (click)="goToTask(t.id)">
                        <div class="task-row">
                          <span class="task-title">{{ t.title }}</span>
                          <span class="task-status" [class]="t.status">{{ uiCopy.statusLabel(t.status) }}</span>
                        </div>
                        @if (getTaskLinkLabels(t.id).length) {
                          <div class="task-link-hint">{{ getTaskLinkLabels(t.id).join(' · ') }}</div>
                        }
                      </li>
                    }
                  </ul>
                </mat-card-content>
              </mat-card>
            }
          }
          @if (p.milestones.length) {
            <mat-card class="overview-card milestones-card">
              <mat-card-header>
                <mat-card-title>Hitos</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <ul class="milestones-list">
                  @for (m of p.milestones; track m.id) {
                    <li class="milestone-item">
                      <span class="status-badge" [class]="m.status">{{ getMilestoneLabel(m.status) }}</span>
                      <span class="milestone-title">{{ m.title }}</span>
                      @if (m.dueDate) {
                        <span class="due">{{ m.dueDate | dateFormat: 'short' }}</span>
                      }
                    </li>
                  }
                </ul>
            </mat-card-content>
          </mat-card>
        }
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Tareas">
      <div class="tab-content tasks-tab">
        <div class="tasks-toolbar">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="toolbar-field">
            <mat-label>Orden</mat-label>
            <mat-select [value]="tasksSortOrder()" (valueChange)="tasksSortOrder.set($event)">
              <mat-option value="default">Por defecto</mat-option>
              <mat-option value="vencidas-primero">Vencidas primero</mat-option>
              <mat-option value="fecha">Por fecha vencimiento</mat-option>
              <mat-option value="estado">Por estado</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="toolbar-field">
            <mat-label>Filtrar</mat-label>
            <mat-select [value]="tasksFilter()" (valueChange)="tasksFilter.set($event)">
              @for (opt of taskFilterOptions; track opt.value) {
                <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
          <div class="toolbar-actions">
            <button
              mat-stroked-button
              color="primary"
              class="toolbar-btn"
              [disabled]="!connectivity.isOnline()"
              (click)="openAddExistingTasks()"
            >
              <mat-icon>link</mat-icon>
              Agregar tareas
            </button>
            <button
              mat-flat-button
              color="primary"
              class="toolbar-btn"
              [disabled]="!connectivity.isOnline()"
              (click)="openAddTask()"
            >
              <mat-icon>add</mat-icon>
              Nueva tarea
            </button>
          </div>
        </div>
        @if (projectTasksDisplay().length) {
          <div class="tasks-list">
            @for (t of projectTasksDisplay(); track t.id) {
              <div class="task-card" (click)="goToTask(t.id)">
                <div class="task-main">
                  <span class="task-title">{{ t.title }}</span>
                  <span class="task-status" [class]="workflow.getEffectiveStatus(t)">{{ workflow.getEffectiveStatus(t) }}</span>
                </div>
                <div class="task-meta">
                  @if (t.assignee) {
                    <span class="assignee">{{ t.assignee }}</span>
                  }
                  @if (t.dueDate) {
                    <span class="due-badge">{{ t.dueDate | dateFormat: 'short' }}</span>
                  }
                  <button
                    mat-icon-button
                    matTooltip="Quitar del proyecto"
                    (click)="unlinkTask(t); $event.stopPropagation()"
                    type="button"
                  >
                    <mat-icon>link_off</mat-icon>
                  </button>
                  <mat-icon>chevron_right</mat-icon>
                </div>
              </div>
            }
          </div>
        } @else {
          <p class="empty-state">Sin tareas. Usa "Agregar tareas" para vincular existentes o "Nueva tarea" para crear una.</p>
        }
      </div>
    </mat-tab>
    <mat-tab label="Archivos">
      <div class="tab-content files-tab">
        @if (p.filesMeta.length) {
          <div class="files-list">
            @for (f of p.filesMeta; track f.id) {
              <div class="file-card">
                <mat-icon>insert_drive_file</mat-icon>
                <div class="file-info">
                  <span class="file-name">{{ f.name }}</span>
                  <span class="file-meta">{{ f.uploadedBy }} · {{ f.uploadedAt | dateFormat: 'short' }}</span>
                </div>
              </div>
            }
          </div>
        } @else {
          <p class="empty-state">Sin archivos adjuntos</p>
        }
      </div>
    </mat-tab>
    <mat-tab label="Métricas">
      <div class="tab-content metrics-tab">
        <div class="metrics-grid">
          <mat-card class="metrics-card progress-card">
            <mat-card-header>
              <mat-card-title>Progreso del proyecto</mat-card-title>
              <mat-card-subtitle>Concluidas (Completada + Liberada) sobre total de tareas</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="progress-display">
                <span class="progress-value">{{ kpis().progressPercent }}%</span>
                <div class="progress-bar-wrap">
                  <div class="progress-bar-fill" [style.width.%]="kpis().progressPercent"></div>
                </div>
                <span class="progress-legend">{{ kpis().completedTasks + kpis().liberadasTasks }} / {{ kpis().totalTasks }} tareas concluidas</span>
              </div>
            </mat-card-content>
          </mat-card>
          <mat-card class="metrics-card chart-card">
            <mat-card-header>
              <mat-card-title>Distribución por estado</mat-card-title>
              <mat-card-subtitle>Solo tareas de este proyecto</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container chart-doughnut">
                <canvas baseChart [data]="projectMetricsDoughnutData()" [options]="projectMetricsDoughnutOptions" [type]="'doughnut'"></canvas>
              </div>
            </mat-card-content>
          </mat-card>
          <mat-card class="metrics-card chart-card">
            <mat-card-header>
              <mat-card-title>Concluidas vs Vencidas</mat-card-title>
              <mat-card-subtitle>Comparativa (solo este proyecto)</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container chart-bar-h">
                <canvas baseChart [data]="projectConcluidasVencidasBarData()" [options]="projectConcluidasVencidasBarOptions" [type]="'bar'"></canvas>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>

  <div class="back-actions">
    <button mat-button (click)="goBack()">Volver a proyectos</button>
  </div>
    </div>

    <aside class="global-activity-sidebar">
      <mat-card class="sidebar-activity-card">
        <mat-card-header>
          <mat-card-title>Actividad reciente</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (p.activity.length) {
            <div class="activity-feed-vertical">
              @for (a of (p.activity | slice:0:15); track a.id) {
                <div class="activity-item">
                  <app-avatar [name]="a.userName ?? a.userId" [size]="28" />
                  <div class="activity-body">
                    <span class="user">{{ a.userName ?? a.userId }}</span>
                    <span class="time">{{ a.timestamp | relativeTime }}</span>
                    <span class="text">{{ getActivityLabel(a.type) }}</span>
                  </div>
                </div>
              }
            </div>
          } @else {
            <p class="empty-state">Sin actividad</p>
          }
        </mat-card-content>
      </mat-card>
    </aside>
  </div>
}
